@import org.graylog2.rest.models.system.indexer.responses.IndexInfo
@import org.graylog2.restclient.models.Index
@(deflectorTarget: String, index: Index, indexInfo: IndexInfo)

@import views.helpers.DateHelper

<div class="index-info">
    @if(index.getRange.isProvidesCalculationInfo) {
        Range re-calculated @DateHelper.readablePeriodFromNow(index.getRange.getCalculatedAt)
        in @(index.getRange.getCalculationTookMs)ms.
    }

    @if(indexInfo == null) {
        <div class="alert alert-info"><i class="fa fa-info-circle"></i> Index information is not available at the moment, please try again later.</div>
    } else {
        @indexInfo.primaryShards.segments segments,
        @indexInfo.primaryShards.openSearchContexts open search contexts,
        @indexInfo.primaryShards.documents.deleted deleted messages

        <div class="row" style="margin-bottom: 10px;">
            @views.html.system.indices.partials.index_stats.render("Primary shard operations", indexInfo.primaryShards())
            @views.html.system.indices.partials.index_stats.render("Total shard operations", indexInfo.allShards())
        </div>

        <div class="shard-routing">
            <h3>Shard routing</h3>

            <ul class="shards">
            @for(route <- indexInfo.routing.sortBy(_.id)) {
                <li class="shard shard-@route.state
                    @if(route.primary) {
                        shard-primary
                    }"

                data-title="State: <i>@route.state</i> on @route.nodeHostname (@route.nodeName)"
                data-html="true"
                >
                <span class="id">S@route.id</span>
                </li>
            }
            </ul>

            <br style="clear: both;" />

            <div class="description">
                Bold shards are primaries, others are replicas. Replicas are elected to primaries automatically
                when primaries leave the cluster. Size and document counts only reflect primary shards and no
                possible replica duplication.
            </div>
        </div>

        <hr style="margin-bottom: 5px; margin-top: 10px;">

        @if(index.getName.equals(deflectorTarget)) {
            <a href="#" class="btn btn-xs btn-warning" disabled>Deflector index cannot be closed</a>
            <a href="#" class="btn btn-xs btn-danger" disabled>Deflector index cannot be deleted</a>
        } else {
            <a href="@routes.IndicesController.closeIndex(index.getName)" class="btn btn-xs btn-warning" data-confirm="Really close index @index.getName?">Close index</a>
            <a href="@routes.IndicesController.deleteIndex(index.getName)" class="btn btn-xs btn-danger" data-confirm="Really delete index @index.getName?">Delete index</a>
        }
    }
</div>